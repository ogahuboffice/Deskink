<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ogahuboffice ‚Äî Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  
  <style>
    :root{ --neon:#7c3aed; --accent:#06b6d4; }
    body{ background: linear-gradient(180deg,#071627 0%, #071426 60%, #0b1020 100%); color:#e6eef8; }
    .neon-card{ background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); box-shadow:0 8px 30px rgba(124,58,237,0.06); border:1px solid rgba(124,58,237,0.08); }
    .neon-icon{ color:var(--neon); filter:drop-shadow(0 0 8px rgba(124,58,237,0.18)); }
    .small-muted{ color:#94a3b8; font-size:.92rem; }
    .status-pending{ color: #fbbf24; }
    .status-completed{ color: #10b981; }
    .status-in-progress{ color: #3b82f6; }
  </style>
</head>

<body class="font-sans min-h-screen">
  <!-- Navigation Bar -->
  <nav class="bg-gray-900 border-b border-gray-800 p-4">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <h1 class="text-2xl font-bold text-white">üè¢ Ogahuboffice</h1>
        <span class="text-sm text-gray-400">Admin Dashboard</span>
      </div>
      <div class="flex items-center space-x-4">
        <div class="relative" id="notificationBell">
          <i class="fas fa-bell text-white/80 text-xl cursor-pointer" onclick="toggleNotifications()"></i>
          <span id="notificationCount" class="absolute -top-2 -right-3 bg-red-500 text-xs px-1 rounded-full hidden">0</span>
        </div>
        <span id="adminName" class="text-white">Loading...</span>
        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg flex items-center space-x-2">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- Notifications Panel -->
  <div id="notificationsPanel" class="fixed right-4 top-20 w-80 bg-gray-800 rounded-lg shadow-xl z-50 hidden">
    <div class="p-4 border-b border-gray-700">
      <h3 class="font-semibold">Notifications</h3>
    </div>
    <div id="notificationsList" class="max-h-96 overflow-y-auto">
      <!-- Notifications will be loaded here -->
    </div>
  </div>

  <div class="max-w-7xl mx-auto p-6">
    <!-- Dashboard Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="neon-card p-6 rounded-2xl">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-semibold">Total Users</h3>
            <p class="small-muted">Registered users</p>
          </div>
          <i class="fas fa-users neon-icon text-2xl"></i>
        </div>
        <div class="mt-4">
          <div class="text-3xl font-bold" id="totalUsers">0</div>
        </div>
      </div>

      <div class="neon-card p-6 rounded-2xl">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-semibold">Total Products</h3>
            <p class="small-muted">Active products</p>
          </div>
          <i class="fas fa-box neon-icon text-2xl"></i>
        </div>
        <div class="mt-4">
          <div class="text-3xl font-bold" id="totalProducts">0</div>
        </div>
      </div>

      <div class="neon-card p-6 rounded-2xl">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-semibold">Total Orders</h3>
            <p class="small-muted">Completed orders</p>
          </div>
          <i class="fas fa-shopping-cart neon-icon text-2xl"></i>
        </div>
        <div class="mt-4">
          <div class="text-3xl font-bold" id="totalOrders">0</div>
        </div>
      </div>

      <div class="neon-card p-6 rounded-2xl">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-semibold">Revenue</h3>
            <p class="small-muted">Total earnings</p>
          </div>
          <i class="fas fa-wallet neon-icon text-2xl"></i>
        </div>
        <div class="mt-4">
          <div class="text-3xl font-bold" id="totalRevenue">‚Ç¶0</div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="neon-card p-6 rounded-2xl">
        <h3 class="text-xl font-semibold mb-4">Quick Actions</h3>
        <div class="grid grid-cols-2 gap-4">
          <button onclick="loadUsers()" class="p-4 bg-blue-500 hover:bg-blue-600 rounded-lg flex items-center justify-between">
            <span>Manage Users</span>
            <i class="fas fa-arrow-right"></i>
          </button>
          <button onclick="loadProductsManagement()" class="p-4 bg-green-500 hover:bg-green-600 rounded-lg flex items-center justify-between">
            <span>Manage Products</span>
            <i class="fas fa-arrow-right"></i>
          </button>
          <button onclick="loadOrders()" class="p-4 bg-purple-500 hover:bg-purple-600 rounded-lg flex items-center justify-between">
            <span>View Orders</span>
            <i class="fas fa-arrow-right"></i>
          </button>
          <button onclick="loadRequests()" class="p-4 bg-indigo-500 hover:bg-indigo-600 rounded-lg flex items-center justify-between">
            <span>Manage Requests</span>
            <i class="fas fa-arrow-right"></i>
          </button>
          <button onclick="loadWithdrawals()" class="p-4 bg-yellow-500 hover:bg-yellow-600 rounded-lg flex items-center justify-between">
            <span>Withdrawals</span>
            <i class="fas fa-arrow-right"></i>
          </button>
          <button onclick="loadNotifications()" class="p-4 bg-pink-500 hover:bg-pink-600 rounded-lg flex items-center justify-between">
            <span>Notifications</span>
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <div class="neon-card p-6 rounded-2xl">
        <h3 class="text-xl font-semibold mb-4">Recent Orders</h3>
        <div id="recentOrders" class="space-y-3">
          <div class="text-center small-muted py-8">Loading orders...</div>
        </div>
      </div>
    </div>

    <!-- Users Section -->
    <div id="usersSection" class="neon-card p-6 rounded-2xl mt-8 hidden">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-semibold">Users Management</h3>
        <button onclick="showAddUserModal()" class="px-4 py-2 rounded bg-green-500 flex items-center gap-2">
          <i class="fas fa-plus"></i>
          <span>Add User</span>
        </button>
      </div>
      <div id="usersList" class="space-y-3">
        <!-- Users will be loaded here -->
      </div>
    </div>

    <!-- Products Management Section -->
    <div id="productsManagementSection" class="neon-card p-6 rounded-2xl mt-8 hidden">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-semibold">Products Management</h3>
        <div class="flex gap-2">
          <select id="productCategorySelect" onchange="loadCategoryProducts()" class="p-2 rounded bg-white/5">
            <option value="all">All Products</option>
            <option value="airtime">Airtime</option>
            <option value="data">Data</option>
            <option value="bills">Bills</option>
          </select>
          <button onclick="showAddProductModal()" class="px-4 py-2 rounded bg-green-500 flex items-center gap-2">
            <i class="fas fa-plus"></i>
            <span>Add Product</span>
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="productsManagementList">
        <!-- Products will be loaded here -->
      </div>
    </div>

    <!-- Orders Section -->
    <div id="ordersSection" class="neon-card p-6 rounded-2xl mt-8 hidden">
      <h3 class="text-xl font-semibold mb-6">Orders Management</h3>
      <div id="ordersList" class="space-y-3">
        <!-- Orders will be loaded here -->
      </div>
    </div>

    <!-- Assignments & Projects Section -->
    <div id="assignmentsSection" class="neon-card p-6 rounded-2xl mt-8 hidden">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-semibold">Assignments & Projects Management</h3>
        <div class="flex gap-2">
          <select id="requestTypeFilter" onchange="loadRequests()" class="p-2 rounded bg-white/5">
            <option value="all">All Requests</option>
            <option value="assignment">Assignments</option>
            <option value="project">Projects</option>
          </select>
          <select id="requestStatusFilter" onchange="loadRequests()" class="p-2 rounded bg-white/5">
            <option value="all">All Status</option>
            <option value="pending">Pending</option>
            <option value="in-progress">In Progress</option>
            <option value="completed">Completed</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="requestsList">
        <!-- Requests will be loaded here -->
      </div>
    </div>

    <!-- Withdrawals Section -->
    <div id="withdrawalsSection" class="neon-card p-6 rounded-2xl mt-8 hidden">
      <h3 class="text-xl font-semibold mb-6">Withdrawal Requests</h3>
      <div id="withdrawalsList" class="space-y-3">
        <!-- Withdrawals will be loaded here -->
      </div>
    </div>

    <!-- Notifications Section -->
    <div id="notificationsSection" class="neon-card p-6 rounded-2xl mt-8 hidden">
      <h3 class="text-xl font-semibold mb-6">All Notifications</h3>
      <div id="allNotificationsList" class="space-y-3">
        <!-- All notifications will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Add User Modal -->
  <div id="addUserModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-gray-900 p-6 rounded-2xl w-96 neon-card">
      <h3 class="text-xl font-semibold mb-4">Add New User</h3>
      <input type="text" id="newUserName" placeholder="Full Name" class="w-full p-3 rounded bg-white/5 mb-3"/>
      <input type="email" id="newUserEmail" placeholder="Email Address" class="w-full p-3 rounded bg-white/5 mb-3"/>
      <input type="text" id="newUserPhone" placeholder="Phone Number" class="w-full p-3 rounded bg-white/5 mb-4"/>
      <select id="newUserRole" class="w-full p-3 rounded bg-white/5 mb-4">
        <option value="user">User</option>
        <option value="staff">Staff</option>
        <option value="cashier">Cashier</option>
        <option value="manager">Manager</option>
        <option value="admin">Admin</option>
      </select>
      <div class="flex gap-2">
        <button onclick="createUser()" class="flex-1 py-3 rounded bg-green-500">Create User</button>
        <button onclick="hideAddUserModal()" class="flex-1 py-3 rounded bg-gray-600">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div id="addProductModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-gray-900 p-6 rounded-2xl w-96 neon-card max-h-96 overflow-y-auto">
      <h3 class="text-xl font-semibold mb-4">Add New Product</h3>
      
      <select id="productType" onchange="showProductForm()" class="w-full p-3 rounded bg-white/5 mb-4">
        <option value="">Select Product Type</option>
        <option value="airtime">Airtime</option>
        <option value="data">Data Plan</option>
        <option value="bills">Bills Payment</option>
      </select>

      <!-- Airtime Form -->
      <div id="airtimeForm" class="hidden space-y-3">
        <select id="airtimeNetwork" class="w-full p-3 rounded bg-white/5">
          <option value="MTN">MTN</option>
          <option value="GLO">GLO</option>
          <option value="AIRTEL">AIRTEL</option>
          <option value="9MOBILE">9MOBILE</option>
        </select>
        <input type="number" id="airtimeAmount" placeholder="Amount (‚Ç¶)" class="w-full p-3 rounded bg-white/5"/>
        <input type="number" id="airtimeDiscount" placeholder="Discount %" class="w-full p-3 rounded bg-white/5" value="0"/>
      </div>

      <!-- Data Form -->
      <div id="dataForm" class="hidden space-y-3">
        <select id="dataNetwork" class="w-full p-3 rounded bg-white/5">
          <option value="MTN">MTN</option>
          <option value="GLO">GLO</option>
          <option value="AIRTEL">AIRTEL</option>
          <option value="9MOBILE">9MOBILE</option>
        </select>
        <select id="dataSize" class="w-full p-3 rounded bg-white/5">
          <option value="100MB">100MB</option>
          <option value="500MB">500MB</option>
          <option value="1GB">1GB</option>
          <option value="2GB">2GB</option>
          <option value="5GB">5GB</option>
          <option value="10GB">10GB</option>
        </select>
        <input type="text" id="dataValidity" placeholder="Validity (e.g., 30 days)" class="w-full p-3 rounded bg-white/5" value="30 days"/>
        <input type="number" id="dataPrice" placeholder="Price (‚Ç¶)" class="w-full p-3 rounded bg-white/5"/>
      </div>

      <!-- Bills Form -->
      <div id="billsForm" class="hidden space-y-3">
        <select id="billsType" class="w-full p-3 rounded bg-white/5">
          <option value="ELECTRICITY">Electricity</option>
          <option value="TV SUBSCRIPTION">TV Subscription</option>
          <option value="WATER BILL">Water Bill</option>
        </select>
        <input type="text" id="billsProvider" placeholder="Provider" class="w-full p-3 rounded bg-white/5"/>
        <input type="number" id="billsAmount" placeholder="Amount (‚Ç¶)" class="w-full p-3 rounded bg-white/5"/>
        <input type="number" id="billsFee" placeholder="Service Fee (‚Ç¶)" class="w-full p-3 rounded bg-white/5" value="100"/>
      </div>

      <div class="flex gap-2 mt-4">
        <button onclick="createSpecificProduct()" class="flex-1 py-3 rounded bg-green-500">Create Product</button>
        <button onclick="hideAddProductModal()" class="flex-1 py-3 rounded bg-gray-600">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Upload Solution Modal (Admin/Staff) -->
  <div id="uploadSolutionModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-gray-900 p-6 rounded-2xl w-96 neon-card">
      <h3 class="text-xl font-semibold mb-4">Upload Solution</h3>
      
      <div id="solutionRequestDetails" class="mb-4 p-3 bg-white/5 rounded">
        <!-- Request details will be shown here -->
      </div>
      
      <textarea id="solutionNotes" placeholder="Solution notes/comments" class="w-full p-3 rounded bg-white/5 mb-3" rows="3"></textarea>
      <input type="number" id="solutionPrice" placeholder="Final Price (‚Ç¶)" class="w-full p-3 rounded bg-white/5 mb-3"/>
      
      <div class="border-2 border-dashed border-white/20 rounded-lg p-4 mb-3">
        <input type="file" id="solutionFileUpload" class="hidden" accept=".pdf,.doc,.docx,.zip,.rar"/>
        <label for="solutionFileUpload" class="cursor-pointer flex flex-col items-center text-white/70">
          <i class="fas fa-cloud-upload-alt text-2xl mb-2"></i>
          <span id="solutionFileLabel" class="text-sm">Upload solution file</span>
        </label>
      </div>

      <div class="flex gap-2">
        <button onclick="uploadSolution()" class="flex-1 py-3 rounded bg-green-500">Upload Solution</button>
        <button onclick="hideUploadSolutionModal()" class="flex-1 py-3 rounded bg-gray-600">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let authToken = null;
    let currentSolutionRequest = null;

    // Check authentication on page load
    document.addEventListener('DOMContentLoaded', function() {
      checkAuth();
      loadDashboard();
      loadNotificationsCount();
    });

    // Authentication functions
    function checkAuth() {
      const token = localStorage.getItem('token');
      const user = localStorage.getItem('user');

      if (!token || !user) {
        window.location.href = '/login';
        return;
      }

      authToken = token;
      currentUser = JSON.parse(user);
      
      // Only allow admin access
      if (currentUser.role !== 'admin') {
        alert('Only administrators can access this dashboard');
        logout();
        return;
      }

      document.getElementById('adminName').textContent = currentUser.name;
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/login';
    }

    // API functions
    async function apiCall(endpoint, options = {}) {
      try {
        const response = await fetch(endpoint, {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json',
            ...options.headers
          },
          ...options
        });

        if (response.status === 401) {
          logout();
          return null;
        }

        return await response.json();
      } catch (error) {
        console.error('API call failed:', error);
        return null;
      }
    }

    // Notifications functions
    async function loadNotificationsCount() {
      const notifications = await apiCall('/api/notifications');
      if (notifications) {
        const unreadCount = notifications.filter(n => !n.read).length;
        const countElement = document.getElementById('notificationCount');
        if (unreadCount > 0) {
          countElement.textContent = unreadCount;
          countElement.classList.remove('hidden');
        } else {
          countElement.classList.add('hidden');
        }
      }
    }

    async function toggleNotifications() {
      const panel = document.getElementById('notificationsPanel');
      if (panel.classList.contains('hidden')) {
        await loadNotifications();
        panel.classList.remove('hidden');
      } else {
        panel.classList.add('hidden');
      }
    }

    async function loadNotifications() {
      const notifications = await apiCall('/api/notifications');
      if (notifications) {
        const container = document.getElementById('notificationsList');
        const recentNotifications = notifications.slice(0, 5); // Show only 5 most recent
        
        if (recentNotifications.length === 0) {
          container.innerHTML = '<div class="p-4 text-center text-gray-400">No notifications</div>';
        } else {
          container.innerHTML = recentNotifications.map(notification => `
            <div class="p-4 border-b border-gray-700 hover:bg-gray-700 cursor-pointer ${notification.read ? '' : 'bg-gray-750'}" 
                 onclick="markAsRead(${notification.id})">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <div class="font-medium ${notification.read ? 'text-gray-300' : 'text-white'}">${notification.title}</div>
                  <div class="text-sm text-gray-400 mt-1">${notification.message}</div>
                  <div class="text-xs text-gray-500 mt-2">${new Date(notification.createdAt).toLocaleString()}</div>
                </div>
                ${!notification.read ? '<div class="w-2 h-2 bg-blue-500 rounded-full ml-2 mt-1"></div>' : ''}
              </div>
            </div>
          `).join('');
        }
        
        // Update count
        await loadNotificationsCount();
      }
    }

    async function loadAllNotifications() {
      hideAllSections();
      document.getElementById('notificationsSection').classList.remove('hidden');
      
      const notifications = await apiCall('/api/notifications');
      if (notifications) {
        const container = document.getElementById('allNotificationsList');
        
        if (notifications.length === 0) {
          container.innerHTML = '<div class="text-center small-muted py-8">No notifications</div>';
        } else {
          container.innerHTML = notifications.map(notification => `
            <div class="flex justify-between items-center p-4 bg-white/5 rounded-lg ${notification.read ? '' : 'border-l-4 border-blue-500'}">
              <div class="flex-1">
                <div class="font-medium">${notification.title}</div>
                <div class="small-muted mt-1">${notification.message}</div>
                <div class="text-xs text-gray-500 mt-2">${new Date(notification.createdAt).toLocaleString()}</div>
              </div>
              <div class="flex gap-2">
                ${!notification.read ? `
                  <button onclick="markAsRead(${notification.id})" class="px-3 py-1 bg-blue-500 rounded text-sm">
                    Mark Read
                  </button>
                ` : ''}
              </div>
            </div>
          `).join('');
        }
      }
    }

    async function markAsRead(notificationId) {
      await apiCall(`/api/notifications/${notificationId}/read`, {
        method: 'PUT'
      });
      await loadNotifications();
      await loadNotificationsCount();
      if (!document.getElementById('notificationsSection').classList.contains('hidden')) {
        await loadAllNotifications();
      }
    }

    // Dashboard functions
    async function loadDashboard() {
      const data = await apiCall('/api/dashboard');
      if (data) {
        document.getElementById('totalUsers').textContent = data.totalUsers;
        document.getElementById('totalProducts').textContent = data.totalProducts;
        document.getElementById('totalOrders').textContent = data.totalOrders;
        document.getElementById('totalRevenue').textContent = `‚Ç¶${data.totalRevenue.toLocaleString()}`;

        // Display recent orders
        const ordersContainer = document.getElementById('recentOrders');
        if (data.recentOrders.length === 0) {
          ordersContainer.innerHTML = '<div class="text-center small-muted py-8">No recent orders</div>';
        } else {
          ordersContainer.innerHTML = data.recentOrders.map(order => `
            <div class="flex justify-between items-center p-3 bg-white/5 rounded-lg">
              <div>
                <div class="font-medium">${order.productName}</div>
                <div class="small-muted text-sm">${order.userName}</div>
              </div>
              <div class="text-right">
                <div class="font-bold">‚Ç¶${order.amount}</div>
                <div class="status-${order.status} text-sm">${order.status}</div>
              </div>
            </div>
          `).join('');
        }
      }
    }

    // Users management
    async function loadUsers() {
      hideAllSections();
      document.getElementById('usersSection').classList.remove('hidden');
      
      const users = await apiCall('/api/users');
      if (users) {
        const container = document.getElementById('usersList');
        container.innerHTML = users.map(user => `
          <div class="flex justify-between items-center p-4 bg-white/5 rounded-lg">
            <div>
              <div class="font-medium">${user.name}</div>
              <div class="small-muted text-sm">${user.email} ‚Ä¢ ${user.phone}</div>
              <div class="flex gap-2 mt-1">
                <span class="px-2 py-1 bg-blue-500 rounded text-xs">${user.role}</span>
                <span class="px-2 py-1 bg-green-500 rounded text-xs">‚Ç¶${user.wallet}</span>
              </div>
            </div>
            <div class="flex gap-2">
              <select onchange="updateUserRole(${user.id}, this.value)" class="p-1 rounded bg-white/5 text-xs">
                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                <option value="staff" ${user.role === 'staff' ? 'selected' : ''}>Staff</option>
                <option value="cashier" ${user.role === 'cashier' ? 'selected' : ''}>Cashier</option>
                <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Manager</option>
                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
              </select>
              <button onclick="deleteUser(${user.id})" class="px-2 py-1 bg-red-500 rounded text-xs">Delete</button>
            </div>
          </div>
        `).join('');
      }
    }

    async function updateUserRole(userId, newRole) {
      const result = await apiCall(`/api/users/${userId}/role`, {
        method: 'PUT',
        body: JSON.stringify({ role: newRole })
      });

      if (result) {
        alert('User role updated successfully!');
        loadUsers();
      }
    }

    async function deleteUser(userId) {
      if (confirm('Are you sure you want to delete this user?')) {
        const result = await apiCall(`/api/users/${userId}`, {
          method: 'DELETE'
        });

        if (result) {
          alert('User deleted successfully!');
          loadUsers();
          loadDashboard();
        }
      }
    }

    function showAddUserModal() {
      document.getElementById('addUserModal').classList.remove('hidden');
    }

    function hideAddUserModal() {
      document.getElementById('addUserModal').classList.add('hidden');
    }

    async function createUser() {
      const name = document.getElementById('newUserName').value;
      const email = document.getElementById('newUserEmail').value;
      const phone = document.getElementById('newUserPhone').value;
      const role = document.getElementById('newUserRole').value;

      const result = await apiCall('/api/register', {
        method: 'POST',
        body: JSON.stringify({
          name,
          email,
          phone,
          password: 'password123', // Default password
          role
        })
      });

      if (result) {
        alert('User created successfully!');
        hideAddUserModal();
        loadUsers();
        loadDashboard();
        
        // Clear form
        document.getElementById('newUserName').value = '';
        document.getElementById('newUserEmail').value = '';
        document.getElementById('newUserPhone').value = '';
      }
    }

    // Products Management Functions
    async function loadProductsManagement() {
      hideAllSections();
      document.getElementById('productsManagementSection').classList.remove('hidden');
      await loadCategoryProducts();
    }

    async function loadCategoryProducts() {
      const category = document.getElementById('productCategorySelect').value;
      let products;

      if (category === 'all') {
        products = await apiCall('/api/products');
      } else {
        products = await apiCall(`/api/products/category/${category}`);
      }

      if (products) {
        const container = document.getElementById('productsManagementList');
        container.innerHTML = products.map(product => `
          <div class="neon-card p-4 rounded-xl">
            <div class="flex justify-between items-start mb-3">
              <div>
                <h4 class="font-semibold text-lg">${product.name}</h4>
                <p class="small-muted text-sm">${product.description}</p>
              </div>
              <span class="px-2 py-1 bg-blue-500 rounded text-xs">${product.category}</span>
            </div>
            
            <div class="space-y-2 mb-4">
              ${product.network ? `<div class="flex justify-between"><span class="small-muted">Network:</span><span>${product.network}</span></div>` : ''}
              ${product.dataSize ? `<div class="flex justify-between"><span class="small-muted">Data Size:</span><span>${product.dataSize}</span></div>` : ''}
              ${product.validity ? `<div class="flex justify-between"><span class="small-muted">Validity:</span><span>${product.validity}</span></div>` : ''}
              ${product.provider ? `<div class="flex justify-between"><span class="small-muted">Provider:</span><span>${product.provider}</span></div>` : ''}
              ${product.discount ? `<div class="flex justify-between"><span class="small-muted">Discount:</span><span class="text-green-400">${product.discount}%</span></div>` : ''}
            </div>

            <div class="flex justify-between items-center">
              <div>
                <div class="text-2xl font-bold text-green-400">‚Ç¶${product.price}</div>
                ${product.amount ? `<div class="small-muted text-sm">Value: ‚Ç¶${product.amount}</div>` : ''}
              </div>
              <button onclick="deleteProduct(${product.id})" class="px-3 py-1 bg-red-500 rounded text-sm">Delete</button>
            </div>
          </div>
        `).join('');
      }
    }

    function showProductForm() {
      // Hide all forms
      document.getElementById('airtimeForm').classList.add('hidden');
      document.getElementById('dataForm').classList.add('hidden');
      document.getElementById('billsForm').classList.add('hidden');

      const productType = document.getElementById('productType').value;
      if (productType) {
        document.getElementById(`${productType}Form`).classList.remove('hidden');
      }
    }

    async function createSpecificProduct() {
      const productType = document.getElementById('productType').value;
      
      if (!productType) {
        alert('Please select a product type');
        return;
      }

      let endpoint = '';
      let payload = {};

      switch (productType) {
        case 'airtime':
          endpoint = '/api/products/airtime';
          payload = {
            network: document.getElementById('airtimeNetwork').value,
            amount: document.getElementById('airtimeAmount').value,
            discount: document.getElementById('airtimeDiscount').value
          };
          break;
        case 'data':
          endpoint = '/api/products/data';
          payload = {
            network: document.getElementById('dataNetwork').value,
            dataSize: document.getElementById('dataSize').value,
            validity: document.getElementById('dataValidity').value,
            price: document.getElementById('dataPrice').value
          };
          break;
        case 'bills':
          endpoint = '/api/products/bills';
          payload = {
            billType: document.getElementById('billsType').value,
            provider: document.getElementById('billsProvider').value,
            amount: document.getElementById('billsAmount').value,
            fee: document.getElementById('billsFee').value
          };
          break;
      }

      // Validate required fields
      for (let key in payload) {
        if (!payload[key]) {
          alert(`Please fill in all ${productType} fields`);
          return;
        }
      }

      const result = await apiCall(endpoint, {
        method: 'POST',
        body: JSON.stringify(payload)
      });

      if (result) {
        alert('Product created successfully!');
        hideAddProductModal();
        loadProductsManagement();
        loadDashboard();
      }
    }

    function showAddProductModal() {
      document.getElementById('addProductModal').classList.remove('hidden');
      // Reset forms
      document.getElementById('productType').value = '';
      showProductForm();
    }

    function hideAddProductModal() {
      document.getElementById('addProductModal').classList.add('hidden');
    }

    async function deleteProduct(productId) {
      if (confirm('Are you sure you want to delete this product?')) {
        // Note: You'll need to add a DELETE endpoint in the backend
        alert('Delete functionality would be implemented here');
      }
    }

    // Orders management
    async function loadOrders() {
      hideAllSections();
      document.getElementById('ordersSection').classList.remove('hidden');
      
      const orders = await apiCall('/api/orders');
      if (orders) {
        const container = document.getElementById('ordersList');
        container.innerHTML = orders.map(order => `
          <div class="flex justify-between items-center p-4 bg-white/5 rounded-lg">
            <div>
              <div class="font-medium">${order.productName}</div>
              <div class="small-muted text-sm">Order by ${order.userName}</div>
              ${order.details.phoneNumber ? `<div class="small-muted text-sm">Phone: ${order.details.phoneNumber}</div>` : ''}
            </div>
            <div class="text-right">
              <div class="font-bold">‚Ç¶${order.amount}</div>
              <div class="status-${order.status} text-sm">${order.status}</div>
              <div class="small-muted text-sm">${new Date(order.createdAt).toLocaleDateString()}</div>
            </div>
          </div>
        `).join('');
      }
    }

    // Requests Management
    async function loadRequests() {
      hideAllSections();
      document.getElementById('assignmentsSection').classList.remove('hidden');
      
      const requests = await apiCall('/api/requests');
      if (requests) {
        const typeFilter = document.getElementById('requestTypeFilter').value;
        const statusFilter = document.getElementById('requestStatusFilter').value;
        
        let allRequests = [
          ...requests.assignments.map(req => ({ ...req, requestType: 'assignment' })),
          ...requests.projects.map(req => ({ ...req, requestType: 'project' }))
        ];

        // Apply filters
        if (typeFilter !== 'all') {
          allRequests = allRequests.filter(req => req.requestType === typeFilter);
        }
        if (statusFilter !== 'all') {
          allRequests = allRequests.filter(req => req.status === statusFilter);
        }

        const container = document.getElementById('requestsList');
        if (allRequests.length === 0) {
          container.innerHTML = '<div class="col-span-2 text-center small-muted py-8">No requests found</div>';
        } else {
          container.innerHTML = allRequests.map(request => `
            <div class="neon-card p-4 rounded-xl">
              <div class="flex justify-between items-start mb-3">
                <div>
                  <h4 class="font-semibold text-lg">${request.title}</h4>
                  <p class="small-muted">${request.subject} ‚Ä¢ ${request.requestType}</p>
                </div>
                <span class="px-2 py-1 rounded text-xs ${getStatusColor(request.status)}">${request.status}</span>
              </div>
              
              <p class="small-muted mb-3">${request.description}</p>
              
              <div class="space-y-2 mb-4">
                <div class="flex justify-between">
                  <span class="small-muted">Student:</span>
                  <span>${request.userName}</span>
                </div>
                <div class="flex justify-between">
                  <span class="small-muted">Deadline:</span>
                  <span>${new Date(request.deadline).toLocaleDateString()}</span>
                </div>
                <div class="flex justify-between">
                  <span class="small-muted">Budget:</span>
                  <span class="font-bold text-green-400">‚Ç¶${request.budget}</span>
                </div>
                <div class="flex justify-between">
                  <span class="small-muted">Submissions:</span>
                  <span>${request.solutions.length}</span>
                </div>
              </div>

              <div class="flex gap-2 mb-3">
                <button onclick="downloadFile('${request.requirementsFile}', '${request.requirementsFileName}')" 
                        class="flex-1 py-2 bg-blue-500 rounded text-sm">
                  <i class="fas fa-download mr-1"></i>Requirements
                </button>
                <button onclick="showUploadSolutionModal(${request.id}, '${request.requestType}')" 
                        class="flex-1 py-2 bg-green-500 rounded text-sm">
                  <i class="fas fa-upload mr-1"></i>Upload Solution
                </button>
              </div>

              <div class="flex gap-2">
                <select onchange="updateRequestStatus(${request.id}, '${request.requestType}', this.value)" class="flex-1 p-2 rounded bg-white/5 text-sm">
                  <option value="pending" ${request.status === 'pending' ? 'selected' : ''}>Pending</option>
                  <option value="in-progress" ${request.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                  <option value="completed" ${request.status === 'completed' ? 'selected' : ''}>Completed</option>
                </select>
              </div>

              ${request.solutions.length > 0 ? `
                <div class="mt-3">
                  <h5 class="font-semibold mb-2">Solutions:</h5>
                  ${request.solutions.map(solution => `
                    <div class="flex justify-between items-center p-2 bg-white/5 rounded mb-1">
                      <div>
                        <div class="text-sm">By: ${solution.uploadedByName}</div>
                        <div class="text-xs small-muted">${new Date(solution.uploadedAt).toLocaleDateString()}</div>
                      </div>
                      <button onclick="downloadFile('${solution.solutionFile}', '${solution.solutionFileName}')" class="px-2 py-1 bg-green-500 rounded text-xs">
                        Download
                      </button>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          `).join('');
        }
      }
    }

    async function updateRequestStatus(requestId, requestType, newStatus) {
      const result = await apiCall(`/api/requests/${requestId}/status`, {
        method: 'PUT',
        body: JSON.stringify({ 
          status: newStatus, 
          requestType: requestType 
        })
      });

      if (result) {
        alert('Request status updated successfully!');
        loadRequests();
      }
    }

    // Admin Solution Upload Functions
    function showUploadSolutionModal(requestId, requestType) {
      currentSolutionRequest = { id: requestId, type: requestType };
      
      // You can load request details here
      document.getElementById('solutionRequestDetails').innerHTML = `
        <div class="text-sm">
          <div class="font-medium">Upload solution for</div>
          <div>Request ID: ${requestId}</div>
          <div>Type: ${requestType}</div>
        </div>
      `;
      
      document.getElementById('uploadSolutionModal').classList.remove('hidden');
    }

    function hideUploadSolutionModal() {
      document.getElementById('uploadSolutionModal').classList.add('hidden');
      currentSolutionRequest = null;
    }

    async function uploadSolution() {
      if (!currentSolutionRequest) return;

      const notes = document.getElementById('solutionNotes').value;
      const price = document.getElementById('solutionPrice').value;
      const fileInput = document.getElementById('solutionFileUpload');

      if (!fileInput.files[0]) {
        alert('Please upload a solution file');
        return;
      }

      const formData = new FormData();
      formData.append('requestId', currentSolutionRequest.id);
      formData.append('requestType', currentSolutionRequest.type);
      formData.append('notes', notes);
      formData.append('price', price);
      formData.append('file', fileInput.files[0]);

      try {
        const response = await fetch('/api/upload-solution', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`
          },
          body: formData
        });

        const result = await response.json();

        if (response.ok) {
          alert('Solution uploaded successfully! User can now download it.');
          hideUploadSolutionModal();
          loadRequests();
          
          // Clear form
          document.getElementById('solutionNotes').value = '';
          document.getElementById('solutionPrice').value = '';
          document.getElementById('solutionFileUpload').value = '';
          document.getElementById('solutionFileLabel').textContent = 'Upload solution file';
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Solution upload failed. Please try again.');
      }
    }

    // Withdrawals management
    async function loadWithdrawals() {
      hideAllSections();
      document.getElementById('withdrawalsSection').classList.remove('hidden');
      
      const transactions = await apiCall('/api/wallet/transactions');
      if (transactions) {
        const withdrawals = transactions.filter(t => t.type === 'withdrawal');
        const container = document.getElementById('withdrawalsList');
        
        if (withdrawals.length === 0) {
          container.innerHTML = '<div class="text-center small-muted py-8">No withdrawal requests</div>';
        } else {
          container.innerHTML = withdrawals.map(withdrawal => `
            <div class="flex justify-between items-center p-4 bg-white/5 rounded-lg">
              <div>
                <div class="font-medium">Withdrawal Request</div>
                <div class="small-muted text-sm">${withdrawal.bankDetails.accountName} - ${withdrawal.bankDetails.bankName}</div>
                <div class="small-muted text-sm">Account: ${withdrawal.bankDetails.accountNumber}</div>
              </div>
              <div class="text-right">
                <div class="font-bold text-red-400">-‚Ç¶${Math.abs(withdrawal.amount)}</div>
                <div class="status-${withdrawal.status} text-sm">${withdrawal.status}</div>
                <div class="small-muted text-sm">${new Date(withdrawal.date).toLocaleDateString()}</div>
              </div>
            </div>
          `).join('');
        }
      }
    }

    function getStatusColor(status) {
      switch(status) {
        case 'pending': return 'bg-yellow-500';
        case 'in-progress': return 'bg-blue-500';
        case 'completed': return 'bg-green-500';
        default: return 'bg-gray-500';
      }
    }

    function downloadFile(fileUrl, fileName = 'download') {
      // Create a temporary link to trigger download
      const link = document.createElement('a');
      link.href = fileUrl;
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function hideAllSections() {
      document.getElementById('usersSection').classList.add('hidden');
      document.getElementById('productsManagementSection').classList.add('hidden');
      document.getElementById('ordersSection').classList.add('hidden');
      document.getElementById('withdrawalsSection').classList.add('hidden');
      document.getElementById('assignmentsSection').classList.add('hidden');
      document.getElementById('notificationsSection').classList.add('hidden');
    }

    // Update the file input label
    document.getElementById('solutionFileUpload').addEventListener('change', function(e) {
      const fileName = e.target.files[0]?.name || 'Upload solution file';
      document.getElementById('solutionFileLabel').textContent = fileName;
    });

    // Close notifications when clicking outside
    document.addEventListener('click', function(event) {
      const notificationsPanel = document.getElementById('notificationsPanel');
      const notificationBell = document.getElementById('notificationBell');
      
      if (!notificationsPanel.contains(event.target) && !notificationBell.contains(event.target)) {
        notificationsPanel.classList.add('hidden');
      }
    });
  </script>
</body>
</html>